<style>
	#canvasContainer {width: 1200px; margin: 30px auto;}
	button { cursor: pointer; }

	.blocker{position:fixed;top:0;right:0;bottom:0;left:0;width:100%;height:100%;overflow:auto;z-index:1;padding:20px;box-sizing:border-box;background-color:#000;background-color:rgba(0,0,0,0.75);text-align:center}.blocker:before{content:"";display:inline-block;height:100%;vertical-align:middle;margin-right:-0.05em}.blocker.behind{background-color:transparent}.modal{display:none;vertical-align:middle;position:relative;z-index:2;max-width:500px;box-sizing:border-box;width:90%;background:#fff;padding:15px 30px;-webkit-border-radius:8px;-moz-border-radius:8px;-o-border-radius:8px;-ms-border-radius:8px;border-radius:8px;-webkit-box-shadow:0 0 10px #000;-moz-box-shadow:0 0 10px #000;-o-box-shadow:0 0 10px #000;-ms-box-shadow:0 0 10px #000;box-shadow:0 0 10px #000;text-align:left}.modal a.close-modal{position:absolute;top:-12.5px;right:-12.5px;display:block;width:30px;height:30px;text-indent:-9999px;background-size:contain;background-repeat:no-repeat;background-position:center center;background-image:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAYAAAA6/NlyAAAAAXNSR0IArs4c6QAAA3hJREFUaAXlm8+K00Acx7MiCIJH/yw+gA9g25O49SL4AO3Bp1jw5NvktC+wF88qevK4BU97EmzxUBCEolK/n5gp3W6TTJPfpNPNF37MNsl85/vN/DaTmU6PknC4K+pniqeKJ3k8UnkvDxXJzzy+q/yaxxeVHxW/FNHjgRSeKt4rFoplzaAuHHDBGR2eS9G54reirsmienDCTRt7xwsp+KAoEmt9nLaGitZxrBbPFNaGfPloGw2t4JVamSt8xYW6Dg1oCYo3Yv+rCGViV160oMkcd8SYKnYV1Nb1aEOjCe6L5ZOiLfF120EjWhuBu3YIZt1NQmujnk5F4MgOpURzLfAwOBSTmzp3fpDxuI/pabxpqOoz2r2HLAb0GMbZKlNV5/Hg9XJypguryA7lPF5KMdTZQzHjqxNPhWhzIuAruOl1eNqKEx1tSh5rfbxdw7mOxCq4qS68ZTjKS1YVvilu559vWvFHhh4rZrdyZ69Vmpgdj8fJbDZLJpNJ0uv1cnr/gjrUhQMuI+ANjyuwftQ0bbL6Erp0mM/ny8Fg4M3LtdRxgMtKl3jwmIHVxYXChFy94/Rmpa/pTbNUhstKV+4Rr8lLQ9KlUvJKLyG8yvQ2s9SBy1Jb7jV5a0yapfF6apaZLjLLcWtd4sNrmJUMHyM+1xibTjH82Zh01TNlhsrOhdKTe00uAzZQmN6+KW+sDa/JD2PSVQ873m29yf+1Q9VDzfEYlHi1G5LKBBWZbtEsHbFwb1oYDwr1ZiF/2bnCSg1OBE/pfr9/bWx26UxJL3ONPISOLKUvQza0LZUxSKyjpdTGa/vDEr25rddbMM0Q3O6Lx3rqFvU+x6UrRKQY7tyrZecmD9FODy8uLizTmilwNj0kraNcAJhOp5aGVwsAGD5VmJBrWWbJSgWT9zrzWepQF47RaGSiKfeGx6Szi3gzmX/HHbihwBser4B9UJYpFBNX4R6vTn3VQnez0SymnrHQMsRYGTr1dSk34ljRqS/EMd2pLQ8YBp3a1PLfcqCpo8gtHkZFHKkTX6fs3MY0blKnth66rKCnU0VRGu37ONrQaA4eZDFtWAu2fXj9zjFkxTBOo8F7t926gTp/83Kyzzcy2kZD6xiqxTYnHLRFm3vHiRSwNSjkz3hoIzo8lCKWUlg/YtGs7tObunDAZfpDLbfEI15zsEIY3U/x/gHHc/G1zltnAgAAAABJRU5ErkJggg==')}.modal-spinner{display:none;position:fixed;top:50%;left:50%;transform:translateY(-50%) translateX(-50%);padding:12px 16px;border-radius:5px;background-color:#111;height:20px}.modal-spinner>div{border-radius:100px;background-color:#fff;height:20px;width:2px;margin:0 1px;display:inline-block;-webkit-animation:sk-stretchdelay 1.2s infinite ease-in-out;animation:sk-stretchdelay 1.2s infinite ease-in-out}.modal-spinner .rect2{-webkit-animation-delay:-1.1s;animation-delay:-1.1s}.modal-spinner .rect3{-webkit-animation-delay:-1.0s;animation-delay:-1.0s}.modal-spinner .rect4{-webkit-animation-delay:-0.9s;animation-delay:-0.9s}@-webkit-keyframes sk-stretchdelay{0%,40%,100%{-webkit-transform:scaleY(0.5)}20%{-webkit-transform:scaleY(1.0)}}@keyframes sk-stretchdelay{0%,40%,100%{transform:scaleY(0.5);-webkit-transform:scaleY(0.5)}20%{transform:scaleY(1.0);-webkit-transform:scaleY(1.0)}}
</style>


<p>
	<button id="zoomIn">+</button>
	<button id="zoomOut">-</button>

	<button id="goLeft"><</button>
	<button id="goRight">></button>
	<button id="goUp">Up</button>
	<button id="goDown">Down</button>
	<button id="goDown">Down</button>
	<a id="save" href="#">Save image</a>
</p>

<div id="canvasContainer">
    <canvas id="c" width="1200" height="800"></canvas>
</div>

<div id="sub-modal" style="display: none;">
	<h2 id="person-name"></h2>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/1.7.20/fabric.min.js"></script>

<script>
	/*
    A simple jQuery modal (http://github.com/kylefox/jquery-modal)
    Version 0.9.1
*/
!function(o){"object"==typeof module&&"object"==typeof module.exports?o(require("jquery"),window,document):o(jQuery,window,document)}(function(o,t,i,e){var s=[],l=function(){return s.length?s[s.length-1]:null},n=function(){var o,t=!1;for(o=s.length-1;o>=0;o--)s[o].$blocker&&(s[o].$blocker.toggleClass("current",!t).toggleClass("behind",t),t=!0)};o.modal=function(t,i){var e,n;if(this.$body=o("body"),this.options=o.extend({},o.modal.defaults,i),this.options.doFade=!isNaN(parseInt(this.options.fadeDuration,10)),this.$blocker=null,this.options.closeExisting)for(;o.modal.isActive();)o.modal.close();if(s.push(this),t.is("a"))if(n=t.attr("href"),this.anchor=t,/^#/.test(n)){if(this.$elm=o(n),1!==this.$elm.length)return null;this.$body.append(this.$elm),this.open()}else this.$elm=o("<div>"),this.$body.append(this.$elm),e=function(o,t){t.elm.remove()},this.showSpinner(),t.trigger(o.modal.AJAX_SEND),o.get(n).done(function(i){if(o.modal.isActive()){t.trigger(o.modal.AJAX_SUCCESS);var s=l();s.$elm.empty().append(i).on(o.modal.CLOSE,e),s.hideSpinner(),s.open(),t.trigger(o.modal.AJAX_COMPLETE)}}).fail(function(){t.trigger(o.modal.AJAX_FAIL);var i=l();i.hideSpinner(),s.pop(),t.trigger(o.modal.AJAX_COMPLETE)});else this.$elm=t,this.anchor=t,this.$body.append(this.$elm),this.open()},o.modal.prototype={constructor:o.modal,open:function(){var t=this;this.block(),this.anchor.blur(),this.options.doFade?setTimeout(function(){t.show()},this.options.fadeDuration*this.options.fadeDelay):this.show(),o(i).off("keydown.modal").on("keydown.modal",function(o){var t=l();27===o.which&&t.options.escapeClose&&t.close()}),this.options.clickClose&&this.$blocker.click(function(t){t.target===this&&o.modal.close()})},close:function(){s.pop(),this.unblock(),this.hide(),o.modal.isActive()||o(i).off("keydown.modal")},block:function(){this.$elm.trigger(o.modal.BEFORE_BLOCK,[this._ctx()]),this.$body.css("overflow","hidden"),this.$blocker=o('<div class="'+this.options.blockerClass+' blocker current"></div>').appendTo(this.$body),n(),this.options.doFade&&this.$blocker.css("opacity",0).animate({opacity:1},this.options.fadeDuration),this.$elm.trigger(o.modal.BLOCK,[this._ctx()])},unblock:function(t){!t&&this.options.doFade?this.$blocker.fadeOut(this.options.fadeDuration,this.unblock.bind(this,!0)):(this.$blocker.children().appendTo(this.$body),this.$blocker.remove(),this.$blocker=null,n(),o.modal.isActive()||this.$body.css("overflow",""))},show:function(){this.$elm.trigger(o.modal.BEFORE_OPEN,[this._ctx()]),this.options.showClose&&(this.closeButton=o('<a href="#close-modal" rel="modal:close" class="close-modal '+this.options.closeClass+'">'+this.options.closeText+"</a>"),this.$elm.append(this.closeButton)),this.$elm.addClass(this.options.modalClass).appendTo(this.$blocker),this.options.doFade?this.$elm.css({opacity:0,display:"inline-block"}).animate({opacity:1},this.options.fadeDuration):this.$elm.css("display","inline-block"),this.$elm.trigger(o.modal.OPEN,[this._ctx()])},hide:function(){this.$elm.trigger(o.modal.BEFORE_CLOSE,[this._ctx()]),this.closeButton&&this.closeButton.remove();var t=this;this.options.doFade?this.$elm.fadeOut(this.options.fadeDuration,function(){t.$elm.trigger(o.modal.AFTER_CLOSE,[t._ctx()])}):this.$elm.hide(0,function(){t.$elm.trigger(o.modal.AFTER_CLOSE,[t._ctx()])}),this.$elm.trigger(o.modal.CLOSE,[this._ctx()])},showSpinner:function(){this.options.showSpinner&&(this.spinner=this.spinner||o('<div class="'+this.options.modalClass+'-spinner"></div>').append(this.options.spinnerHtml),this.$body.append(this.spinner),this.spinner.show())},hideSpinner:function(){this.spinner&&this.spinner.remove()},_ctx:function(){return{elm:this.$elm,$elm:this.$elm,$blocker:this.$blocker,options:this.options}}},o.modal.close=function(t){if(o.modal.isActive()){t&&t.preventDefault();var i=l();return i.close(),i.$elm}},o.modal.isActive=function(){return s.length>0},o.modal.getCurrent=l,o.modal.defaults={closeExisting:!0,escapeClose:!0,clickClose:!0,closeText:"Close",closeClass:"",modalClass:"modal",blockerClass:"jquery-modal",spinnerHtml:'<div class="rect1"></div><div class="rect2"></div><div class="rect3"></div><div class="rect4"></div>',showSpinner:!0,showClose:!0,fadeDuration:null,fadeDelay:1},o.modal.BEFORE_BLOCK="modal:before-block",o.modal.BLOCK="modal:block",o.modal.BEFORE_OPEN="modal:before-open",o.modal.OPEN="modal:open",o.modal.BEFORE_CLOSE="modal:before-close",o.modal.CLOSE="modal:close",o.modal.AFTER_CLOSE="modal:after-close",o.modal.AJAX_SEND="modal:ajax:send",o.modal.AJAX_SUCCESS="modal:ajax:success",o.modal.AJAX_FAIL="modal:ajax:fail",o.modal.AJAX_COMPLETE="modal:ajax:complete",o.fn.modal=function(t){return 1===this.length&&new o.modal(this,t),this},o(i).on("click.modal",'a[rel~="modal:close"]',o.modal.close),o(i).on("click.modal",'a[rel~="modal:open"]',function(t){t.preventDefault(),o(this).modal()})});
</script>

<script>
	var canvas = new fabric.Canvas('c');
	canvas.selection = false;
	canvas.backgroundColor = '#ADE2FF';

	var canvasBottom = 4 * 1000;
	var stickmanHeight = 200;
	var grasswidth = 655;
	var grassHeight = 700;

	function loadData() {
		for (var x in localStorage) {
			var person = localStorage[x];
			console.log(person);
		}
	}

	function addSkyScrapers() {
		fabric.Image.fromURL('/images/skyscraper1.png', function(oImg) {
			oImg.set({'left': 1600});
			oImg.set({'top': canvasBottom - grassHeight});
			oImg.originY = 'bottom';
			oImg.hasControls = false;
			oImg.hasBorders = false;
			oImg.selectable = false;
			// oImg.hoverCursor = 'pointer';
			oImg.hoverCursor = 'cursor';

			canvas.add(oImg);
		});

		fabric.Image.fromURL('/images/skyscraper2.png', function(oImg) {
			oImg.set({'left': 4000});
			oImg.set({'top': canvasBottom - grassHeight});
			oImg.originY = 'bottom';
			oImg.hasControls = false;
			oImg.hasBorders = false;
			oImg.selectable = false;
			// oImg.hoverCursor = 'pointer';
			oImg.hoverCursor = 'cursor';

			canvas.add(oImg);
		});
	}

	function addGrass() {
		var amountOfGrass = 0;

		for (var x = 0; x < 20; x++) {
			fabric.Image.fromURL('/images/grass.png', function(oImg) {
				oImg.set({'left': -2000 + (grasswidth * amountOfGrass++)});
				oImg.set({'top': canvasBottom});
				oImg.originY = 'bottom';
				oImg.hasControls = false;
				oImg.hasBorders = false;
				oImg.selectable = false;
				// oImg.hoverCursor = 'pointer';
				oImg.hoverCursor = 'cursor';

				canvas.add(oImg);

				oImg.moveTo(999);
			});
		}
	}

	function setZoomScale() {
		canvas.setZoom(0.1);
		pan(200, 450);
	}

	addSkyScrapers();
	addGrass();
	setZoomScale();

	addPerson('/images/person1.png', 'Matt');
	addPerson('/images/person2.png', 'Kat');
	addPerson('/images/person3.png', 'Nicola');
	addPerson('/images/person4.png', 'Shelley');
	addPerson('/images/person5.png', 'Alexandra');
	addPerson('/images/person6.png', 'David');

	// setInterval(function() {
	// 	addPerson('/images/person7.png', 'David');
	// }, 1000);

	var numberOfPeople = 0;

	function addPerson(image, name) {
		fabric.Image.fromURL(image, function(oImg) {
			oImg.set({'left': 400});
			oImg.set({'top': canvasBottom - grassHeight - (numberOfPeople++ * stickmanHeight)});
			oImg.originY = 'bottom';
			oImg.hasControls = false;
			oImg.hasBorders = false;
			oImg.selectable = false;
			oImg.hoverCursor = 'pointer';
			// oImg.hoverCursor = 'cursor';

			oImg.custom = {
				name: name
			};

			canvas.add(oImg);
		});
	}

	canvas.on('mouse:up', function(options) {
		if (options.target && options.target.custom) {
			var name = options.target.custom.name;

			$('#person-name').html(name);

			$('#sub-modal').modal({
				closeExisting: false
			});
		}
	});

	function zoomIn(amount) {
		amount = amount ? amount : 1.1;
		canvas.setZoom(canvas.getZoom() * amount);
	}

	function zoomOut(amount) {
		amount = amount ? amount : 1.1;
		canvas.setZoom(canvas.getZoom() / amount);
	}

	function pan(horizonal, vertical) {
		var delta = new fabric.Point(horizonal, vertical);
		canvas.relativePan(delta);
	}


	$(function(){
		var zooming = '';
		var timer = setInterval(function() {
			if (zooming === 'in') {
				zoomIn(1.01);
			}
			if (zooming === 'out') {
				zoomOut(1.01);
			}
		}, 20);

		$('#zoomIn').on('mousedown', function(){
			//zoomIn();
			zooming = 'in';
		});

		$('#zoomOut').on('mousedown', function(){
			// zoomOut();
			zooming = 'out';
		});

		$('#zoomIn').on('mouseup', function(){
			zooming = '';
		});

		$('#zoomOut').on('mouseup', function(){
			zooming = '';
		});

		$('#goRight').click(function(){
			pan(10, 0);
		});

		$('#goLeft').click(function(){
			pan(-10, 0);
		});

		$('#goUp').click(function(){
			pan(0, -10);
		});

		$('#goDown').click(function(){
			pan(0, 10);
		});

		$('#save').click(function(){
      		var image = $('#c')[0].toDataURL('image/png').replace('image/png', 'image/octet-stream');

      		console.log(image);
			var filename = 'standup_' + (new Date()).getTime() + '.png';

			$(this).attr('href', image).attr('download', filename);
		});

		var $canvas = $('.upper-canvas');
		var lastX=$canvas[0].width/2, lastY=$canvas[0].height/2;
		var dragStart, dragged;

		$canvas[0].addEventListener('mousedown',function(evt) {
			document.body.style.mozUserSelect = document.body.style.webkitUserSelect = document.body.style.userSelect = 'none';
			lastX = evt.offsetX || (evt.pageX - $canvas[0].offsetLeft);
			lastY = evt.offsetY || (evt.pageY - $canvas[0].offsetTop);
			dragStart = [lastX, lastY];
			dragged = false;
		}, false);

		$canvas[0].addEventListener('mousemove',function(evt) {
			lastX = evt.offsetX || (evt.pageX - $canvas[0].offsetLeft);
			lastY = evt.offsetY || (evt.pageY - $canvas[0].offsetTop);
			dragged = true;
			if (dragStart) {
				var pt = [lastX, lastY];
				var scale = 0.12;
				pan((pt[0]-dragStart[0]) * scale, (pt[1]-dragStart[1]) * scale);
				// ctx.translate(pt.x-dragStart.x,pt.y-dragStart.y);
				// redraw();
			}
		}, false);

		$canvas[0].addEventListener('mouseup',function(evt){
			dragStart = null;
			// if (!dragged) zoom(evt.shiftKey ? -1 : 1 );
		},false);
	});
</script>